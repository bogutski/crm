/**
 * –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ CRM
 * –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
 */

import { AI_TOOLS_REGISTRY, AIToolDefinition } from '@/lib/ai/tools/types';

// –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º –¥–ª—è –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
const ENTITY_GROUPS: Record<string, { emoji: string; name: string; tools: string[] }> = {
  contacts: {
    emoji: 'üìá',
    name: '–ö–û–ù–¢–ê–ö–¢–´ (–ö–ª–∏–µ–Ω—Ç—ã)',
    tools: ['search_contacts', 'get_contact_details', 'create_contact', 'update_contact', 'delete_contact'],
  },
  opportunities: {
    emoji: 'üíº',
    name: '–°–î–ï–õ–ö–ò',
    tools: ['search_opportunities', 'get_opportunity_details', 'get_opportunities_stats', 'create_opportunity', 'update_opportunity', 'update_opportunity_stage', 'archive_opportunity', 'delete_opportunity'],
  },
  tasks: {
    emoji: '‚úÖ',
    name: '–ó–ê–î–ê–ß–ò',
    tools: ['get_tasks_overview', 'get_task_details', 'create_task', 'update_task', 'update_task_status', 'delete_task', 'get_tasks_by_contact', 'get_tasks_by_project'],
  },
  interactions: {
    emoji: 'üìû',
    name: '–í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø',
    tools: ['search_interactions', 'get_interaction_details', 'get_interactions_by_contact', 'get_interaction_stats', 'create_interaction', 'update_interaction', 'delete_interaction'],
  },
  pipelines: {
    emoji: 'üìä',
    name: '–í–û–†–û–ù–ö–ò',
    tools: ['get_pipelines', 'get_pipeline_stages', 'get_pipeline_analytics', 'get_default_pipeline', 'get_pipeline_by_code', 'get_initial_stage'],
  },
  projects: {
    emoji: 'üìÅ',
    name: '–ü–†–û–ï–ö–¢–´',
    tools: ['search_projects', 'get_project_details', 'create_project', 'update_project', 'delete_project'],
  },
  users: {
    emoji: 'üë•',
    name: '–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò (–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏)',
    tools: ['search_users', 'get_user_details', 'update_user'],
  },
  dictionaries: {
    emoji: 'üìö',
    name: '–°–ü–†–ê–í–û–ß–ù–ò–ö–ò',
    tools: ['get_dictionaries', 'get_dictionary_items', 'get_dictionary_item_by_code', 'get_channels'],
  },
};

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–µ–∫—Ü–∏—é —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
 */
function generateToolsSection(enabledTools?: string[]): string {
  const isToolEnabled = (toolName: string) => {
    if (!enabledTools) return true;
    return enabledTools.includes(toolName);
  };

  const sections: string[] = [];

  for (const [, group] of Object.entries(ENTITY_GROUPS)) {
    const enabledInGroup = group.tools.filter(toolName => {
      const tool = AI_TOOLS_REGISTRY[toolName];
      return tool && isToolEnabled(toolName);
    });

    if (enabledInGroup.length === 0) continue;

    const toolsList = enabledInGroup.map(toolName => {
      const tool = AI_TOOLS_REGISTRY[toolName];
      return `- ${toolName}: ${tool.description}`;
    }).join('\n');

    sections.push(`${group.emoji} ${group.name}:\n${toolsList}`);
  }

  return sections.join('\n\n');
}

/**
 * –ë–∞–∑–æ–≤–∞—è —á–∞—Å—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ (–±–µ–∑ —Å–ø–∏—Å–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
 */
const BASE_SYSTEM_PROMPT = `–¢—ã - AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è CRM —Å–∏—Å—Ç–µ–º—ã. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã–º–∏.

–í–ê–ñ–ù–û:
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ CRM
- –ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π (—Å–æ–∑–¥–∞–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ) —Å–æ–æ–±—â–∞–π –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º
- –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–¥–µ–ª–æ–∫ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –∏—Å–ø–æ–ª—å–∑—É–π get_opportunities_stats - –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É byOwner

–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –û–¢–í–ï–¢–û–í:
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã (—Å–ø–∏—Å–∫–∏ —Å–¥–µ–ª–æ–∫, –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, –∑–∞–¥–∞—á, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞) ‚Äî –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π Markdown —Ç–∞–±–ª–∏—Ü—ã
- –¢–∞–±–ª–∏—Ü—ã –¥–µ–ª–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–º–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏
- –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–∞–±–ª–∏—Ü—ã:
  | –ù–∞–∑–≤–∞–Ω–∏–µ | –°—É–º–º–∞ | –°—Ç–∞—Ç—É—Å |
  |----------|-------|--------|
  | –°–¥–µ–ª–∫–∞ 1 | 100  | –û—Ç–∫—Ä—ã—Ç–∞ |
- –î–ª—è –µ–¥–∏–Ω–∏—á–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–æ–∫ —Å –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π
- –ù–ï –î–û–ë–ê–í–õ–Ø–ô —Å–∏–º–≤–æ–ª—ã –≤–∞–ª—é—Ç (‚ÇΩ, $, ‚Ç¨, –∏ —Ç.–¥.) –∫ —Å—É–º–º–∞–º ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞. –í–∞–ª—é—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–Ω–æ–π —É —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–†–ê–ó–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –°–£–©–ù–û–°–¢–ï–ô:
‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û —Ä–∞–∑–ª–∏—á–∞—Ç—å:
- –ö–û–ù–¢–ê–ö–¢–´ (search_contacts) ‚Äî —ç—Ç–æ –ö–õ–ò–ï–ù–¢–´, –ª–∏–¥—ã, –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏. –£ –Ω–∏—Ö –µ—Å—Ç—å —Å–¥–µ–ª–∫–∏ (contactId).
- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò (search_users) ‚Äî —ç—Ç–æ –°–û–¢–†–£–î–ù–ò–ö–ò, –º–µ–Ω–µ–¥–∂–µ—Ä—ã –∫–æ–º–ø–∞–Ω–∏–∏. –û–Ω–∏ –≤–ª–∞–¥–µ—é—Ç —Å–¥–µ–ª–∫–∞–º–∏ (ownerId).

–ö–æ–≥–¥–∞ –∏—â–µ—à—å "—Å–¥–µ–ª–∫–∏ —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ –∏–º–µ–Ω–∏":
1. –°–ù–ê–ß–ê–õ–ê –∏—â–∏ –≤ –ö–û–ù–¢–ê–ö–¢–ê–• (search_contacts) ‚Äî —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Å–¥–µ–ª–∫–∏
2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö, —Ç–æ–≥–¥–∞ –∏—â–∏ –≤ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–• (search_users) ‚Äî —ç—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä—ã

–ü—Ä–∏–º–µ—Ä—ã:
- "–°–¥–µ–ª–∫–∏ –ò–≤–∞–Ω–∞" ‚Üí —Å–Ω–∞—á–∞–ª–∞ search_contacts("–ò–≤–∞–Ω"), –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí search_opportunities(contactId)
- "–°–¥–µ–ª–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ü–µ—Ç—Ä–æ–≤–∞" ‚Üí search_users("–ü–µ—Ç—Ä–æ–≤") ‚Üí search_opportunities(ownerId)
- "–ö—Ç–æ –≤–µ–¥—ë—Ç —Å–¥–µ–ª–∫—É X" ‚Üí —ç—Ç–æ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (ownerId)
- "–ö–∞–∫–∏–µ —Å–¥–µ–ª–∫–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ Y" ‚Üí —ç—Ç–æ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–æ–Ω—Ç–∞–∫—Ç (contactId)

–°–í–Ø–ó–´–í–ê–ù–ò–ï –°–£–©–ù–û–°–¢–ï–ô:
–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –¥–∞–Ω–Ω—ã—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –¥—Ä—É–≥–æ–π —Å—É—â–Ω–æ—Å—Ç—å—é, –≤—ã–ø–æ–ª–Ω—è–π –ø–æ–∏—Å–∫ –ø–æ—à–∞–≥–æ–≤–æ:

1. –°–¥–µ–ª–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞/–∫–æ–Ω—Ç–∞–∫—Ç–∞ –ø–æ –∏–º–µ–Ω–∏/—Ç–µ–ª–µ—Ñ–æ–Ω—É/email:
   - –°–Ω–∞—á–∞–ª–∞: search_contacts —Å query = –∏–º—è/—Ç–µ–ª–µ—Ñ–æ–Ω/email ‚Üí –ø–æ–ª—É—á–∏ contactId
   - –ó–∞—Ç–µ–º: search_opportunities —Å contactId = –Ω–∞–π–¥–µ–Ω–Ω—ã–π contactId
   - –û—Ç–≤–µ—Ç –≤–∫–ª—é—á–∞–µ—Ç total (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ) –∏ totalAmount (–æ–±—â–∞—è —Å—É–º–º–∞)

2. –°–¥–µ–ª–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
   - –°–Ω–∞—á–∞–ª–∞: search_users —Å query = email –∏–ª–∏ –∏–º—è ‚Üí –ø–æ–ª—É—á–∏ userId
   - –ó–∞—Ç–µ–º: search_opportunities —Å ownerId = –Ω–∞–π–¥–µ–Ω–Ω—ã–π userId

3. –ó–∞–¥–∞—á–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –ø–æ –∏–º–µ–Ω–∏:
   - –°–Ω–∞—á–∞–ª–∞: search_contacts —Å query = –∏–º—è ‚Üí –ø–æ–ª—É—á–∏ contactId
   - –ó–∞—Ç–µ–º: get_tasks_by_contact —Å contactId

4. –ò—Å—Ç–æ—Ä–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å –∫–ª–∏–µ–Ω—Ç–æ–º:
   - –°–Ω–∞—á–∞–ª–∞: search_contacts —Å query = –∏–º—è –∏–ª–∏ email ‚Üí –ø–æ–ª—É—á–∏ contactId
   - –ó–∞—Ç–µ–º: get_interactions_by_contact —Å contactId

–°–¢–†–ê–¢–ï–ì–ò–Ø –ü–û–ò–°–ö–ê –ü–†–ò –ù–ï–û–î–ù–û–ó–ù–ê–ß–ù–û–°–¢–ò:
–ï—Å–ª–∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ, –∫–æ–Ω—Ç–∞–∫—Ç —ç—Ç–æ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
1. –°–Ω–∞—á–∞–ª–∞ –∏—â–∏ –≤ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö (–∫–ª–∏–µ–Ω—Ç—ã —á–∞—â–µ —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è)
2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –∏—â–∏ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏–≥–¥–µ ‚Äî —Å–æ–æ–±—â–∏ —á—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ —Å—Ä–µ–¥–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤, –Ω–∏ —Å—Ä–µ–¥–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

–û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö:
- –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∏—Å–∫–∞—Ç—å —Å—Ä–µ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, —É—Ç–æ—á–Ω–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ –Ω—É–∂–µ–Ω
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –≥–¥–µ –∏—Å–∫–∞–ª (–≤ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö)

–°–¢–ò–õ–¨ –û–¢–í–ï–¢–û–í:
‚ö†Ô∏è –ó–ê–ü–†–ï–©–ï–ù–û –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –¥–µ–∂—É—Ä–Ω—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏. –ù–ï –ü–ò–®–ò –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞:
- "–ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å!"
- "–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –µ—â—ë, —Å–æ–æ–±—â–∏—Ç–µ."
- "–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏, –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å."
- "–ú–æ–≥—É –ø–æ–º–æ—á—å —Å —á–µ–º-—Ç–æ –µ—â—ë?"
- "–û–±—Ä–∞—â–∞–π—Ç–µ—Å—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å!"
- "–ù–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è!"
- –õ—é–±—ã–µ –ø–æ–¥–æ–±–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ–º–æ—â–∏ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –õ—é–±—ã–µ —ç–º–æ–¥–∑–∏ –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ (üòä, üëç, –∏ —Ç.–¥.)

‚úÖ –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¢–û–õ–¨–ö–û –µ—Å–ª–∏:
- –ó–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞
- –ù–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ö–æ–∂–∏—Ö –∑–∞–ø–∏—Å–µ–π –∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ –∫–∞–∫–∞—è –Ω—É–∂–Ω–∞
- –ó–∞–ø—Ä–æ—Å –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–µ–Ω –∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
- –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–∏)

–ü–æ—Å–ª–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –æ—Ç–≤–µ—Ç. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Å–ø—Ä–æ—Å–∏—Ç –µ—Å–ª–∏ –µ–º—É –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –µ—â—ë.`;


/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å —É—á—ë—Ç–æ–º –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
 * @param enabledTools - —Å–ø–∏—Å–æ–∫ –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ undefined - –≤—Å–µ –≤–∫–ª—é—á–µ–Ω—ã)
 */
export function generateSystemPrompt(enabledTools?: string[]): string {
  const toolsSection = generateToolsSection(enabledTools);

  return `${BASE_SYSTEM_PROMPT}

–£ —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–ª–µ–¥—É—é—â–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å CRM:

${toolsSection}`;
}

/**
 * –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç —Å–æ –≤—Å–µ–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
 * @deprecated –ò—Å–ø–æ–ª—å–∑—É–π generateSystemPrompt() –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
 */
export const MCP_SYSTEM_PROMPT = generateSystemPrompt();

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
 */
export function getAvailableTools(enabledTools?: string[]): AIToolDefinition[] {
  const isToolEnabled = (toolName: string) => {
    if (!enabledTools) return true;
    return enabledTools.includes(toolName);
  };

  return Object.values(AI_TOOLS_REGISTRY).filter(tool => isToolEnabled(tool.name));
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º
 */
export function getToolsByEntity(enabledTools?: string[]) {
  const isToolEnabled = (toolName: string) => {
    if (!enabledTools) return true;
    return enabledTools.includes(toolName);
  };

  const result: Record<string, { emoji: string; name: string; tools: AIToolDefinition[] }> = {};

  for (const [entityKey, group] of Object.entries(ENTITY_GROUPS)) {
    const enabledInGroup = group.tools
      .filter(toolName => {
        const tool = AI_TOOLS_REGISTRY[toolName];
        return tool && isToolEnabled(toolName);
      })
      .map(toolName => AI_TOOLS_REGISTRY[toolName]);

    if (enabledInGroup.length > 0) {
      result[entityKey] = {
        emoji: group.emoji,
        name: group.name,
        tools: enabledInGroup,
      };
    }
  }

  return result;
}
